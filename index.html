<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Learn English with Ms. Th√∫y - Auto Translate</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg: linear-gradient(135deg,#fdfbfb,#e6f0ff);
  --card: #ffffff;
  --active: linear-gradient(90deg,#c7d2fe,#e0f2fe);
  --btn: linear-gradient(135deg,#93c5fd,#a5b4fc);
  --accent: #6366f1;
}

body{ margin:0; font-family:Poppins,sans-serif; background:var(--bg); color: #333; }
header{ text-align:center; padding:30px 20px; }
header h1{ margin:0; color: var(--accent); }
header p{ margin:8px 0; color:#666; }

.main{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:25px;
  padding:0 20px 20px;
  align-items:start;
}

@media(max-width:900px){ .main{grid-template-columns:1fr} }

.card{
  background:var(--card);
  border-radius:22px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.05);
}

.subtitle-box{
  max-height:70vh;
  overflow-y:auto;
  scroll-behavior: smooth;
}

.subtitle-line{
  padding:15px;
  margin-bottom:12px;
  border-radius:15px;
  border: 1px solid #f0f0f0;
  transition:.3s;
  cursor:pointer;
}

.subtitle-line:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.subtitle-line.active{ background:var(--active); border-color: #93c5fd; }

.row{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom: 8px; }
.row:last-child { margin-bottom: 0; }

input{
  padding:10px;
  border-radius:10px;
  border:1.5px solid #eee;
  width:150px;
  outline: none;
}
input:focus { border-color: var(--accent); }

button{
  padding:10px 16px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:var(--btn);
  color:white;
  font-weight:600;
  transition: 0.2s;
}
button:hover { opacity: 0.9; transform: scale(1.02); }

.trans-text { font-size: 0.9em; color: #666; font-style: italic; display: block; margin-top: 5px; }
.result{ font-size:14px; font-weight: 600; }
.correct{ color:#16a34a; }
.wrong{ color:#dc2626; }

.summary{ margin:20px auto; max-width: 400px; text-align:center; }
#summaryResult { font-weight: 600; margin-top: 10px; color: var(--accent); }

/* Hi·ªáu ·ª©ng loading ƒë∆°n gi·∫£n */
.loading-text { font-size: 12px; color: #999; }
</style>
</head>

<body>

<header>
  <h1>Learn English with Ms. Th√∫y</h1>
  <p>B√†i h·ªçc: <b>Addicted to Sugar</b></p>
</header>

<div class="main">
  <div class="card" style="position: sticky; top: 20px;">
    <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius: 15px;">
        <iframe id="player" style="position:absolute; top:0; left:0; width:100%; height:100%;"
        src="https://www.youtube.com/embed/FjU9qyTZ_OU?enablejsapi=1" 
        frameborder="0" allowfullscreen></iframe>
    </div>
  </div>

  <div class="card subtitle-box" id="subs">
      <p style="text-align:center; color:#999;">ƒêang t·∫£i ph·ª• ƒë·ªÅ v√† b·∫£n d·ªãch...</p>
  </div>
</div>

<div class="summary card">
  <button onclick="showSummary()" style="width: 100%;">üìä Xem t·ªïng k·∫øt k·∫øt qu·∫£</button>
  <p id="summaryResult"></p>
</div>

<script>
const stopWords=["the","a","an","to","of","and","or","is","was","were","be","have","has","had","in","on","at","for","with","that","this","it","as","by","from","but","so","if","then","than"];

let player;
let subtitles = [], results = [];

// YouTube API
function onYouTubeIframeAPIReady(){ player = new YT.Player('player'); }
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

// T·ª± ƒë·ªông d·ªãch qua MyMemory API
async function translateText(text) {
    try {
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi`);
        const data = await response.json();
        return data.responseData.translatedText || "Kh√¥ng c√≥ b·∫£n d·ªãch";
    } catch (e) {
        return "L·ªói d·ªãch thu·∫≠t";
    }
}

function chooseKeyword(sentence){
    const words = sentence.toLowerCase().replace(/[^a-z\s]/g,"").split(" ").filter(w => w.length > 3 && !stopWords.includes(w));
    return words.length > 0 ? words[Math.floor(words.length/2)] : "sugar";
}

// Gi·∫£ l·∫≠p load file SRT (V√¨ kh√¥ng c√≥ file v·∫≠t l√Ω ·ªü ƒë√¢y, t√¥i d√πng chu·ªói m·∫´u)
// Trong th·ª±c t·∫ø, b·∫°n d√πng fetch("subtitles.srt") nh∆∞ c≈©
const demoSRT = `1
00:00:01,000 --> 00:00:04,000
Sugar is found in many different foods.

2
00:00:04,500 --> 00:00:08,000
Many people are addicted to sweet drinks.

3
00:00:08,500 --> 00:00:12,000
Eating too much sugar is bad for your health.`;

async function initApp() {
    // ƒê·ªÉ d√πng file th·∫≠t, h√£y uncomment d√≤ng d∆∞·ªõi v√† comment d√≤ng parseSRT(demoSRT)
    // const res = await fetch("subtitles.srt"); const data = await res.text(); parseSRT(data);
    parseSRT(demoSRT);
}

async function parseSRT(data){
    const blocks = data.trim().split(/\n\n+/);
    const box = document.getElementById("subs");
    box.innerHTML = ""; // X√≥a d√≤ng loading

    for(let i=0; i < blocks.length; i++){
        const lines = blocks[i].split("\n");
        if(lines.length >= 3){
            const time = lines[1].split(" --> ");
            const text = lines.slice(2).join(" ");
            const key = chooseKeyword(text);
            
            // G·ªçi API d·ªãch t·ª´ng d√≤ng
            const viTranslation = await translateText(text);

            subtitles.push({
                start: timeToSec(time[0]),
                end: timeToSec(time[1]),
                full: text,
                blank: text.replace(new RegExp(key,"i"), "______"),
                answer: key,
                vi: viTranslation
            });
            results.push(null);
            renderLine(i);
        }
    }
}

function timeToSec(t){
    const [h,m,s] = t.replace(",",".").split(":");
    return +h*3600 + +m*60 + +s;
}

function renderLine(i){
    const s = subtitles[i];
    const div = document.createElement("div");
    div.className = "subtitle-line";
    div.id = "line" + i;
    div.innerHTML = `
        <div class="row" onclick="player.seekTo(${s.start}, true)">
            <b style="font-size: 1.1em; color: #444;">${s.blank}</b>
        </div>
        <div class="row">
            <span class="trans-text" id="trans${i}">üáªüá≥ ${s.vi}</span>
        </div>
        <div class="row" style="margin-top:10px">
            <input id="in${i}" placeholder="ƒêi·ªÅn t·ª´ c√≤n thi·∫øu..." onkeypress="if(event.key==='Enter') check(${i})">
            <button onclick="check(${i})">Ki·ªÉm tra</button>
            <span id="res${i}" class="result"></span>
        </div>
    `;
    document.getElementById("subs").appendChild(div);
}

function check(i){
    const inputField = document.getElementById("in"+i);
    const val = inputField.value.trim().toLowerCase();
    const res = document.getElementById("res"+i);

    if(val === subtitles[i].answer.toLowerCase()){
        res.textContent = "‚úî Ch√≠nh x√°c!";
        res.className = "result correct";
        inputField.style.borderColor = "#16a34a";
        results[i] = true;
    } else {
        res.textContent = "‚úò Th·ª≠ l·∫°i nh√©";
        res.className = "result wrong";
        inputField.style.borderColor = "#dc2626";
        results[i] = false;
    }
}

// Highlighting khi video ch·∫°y
setInterval(() => {
    if(!player || !player.getCurrentTime) return;
    const t = player.getCurrentTime();
    subtitles.forEach((s, i) => {
        const line = document.getElementById("line" + i);
        if(line) {
            if(t >= s.start && t < s.end){
                if(!line.classList.contains("active")){
                    line.classList.add("active");
                    line.scrollIntoView({behavior: "smooth", block: "center"});
                }
            } else {
                line.classList.remove("active");
            }
        }
    });
}, 500);

function showSummary(){
    const correct = results.filter(r => r === true).length;
    const total = subtitles.length;
    const percent = Math.round((correct/total)*100);
    document.getElementById("summaryResult").innerHTML = 
        `K·∫øt qu·∫£: ${correct}/${total} c√¢u (${percent}%)<br>` + 
        (percent >= 80 ? "üéâ Tuy·ªát v·ªùi qu√° Ms. Th√∫y ∆°i!" : "üí™ C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©!");
}

// Kh·ªüi ch·∫°y
initApp();
</script>

</body>
</html>
