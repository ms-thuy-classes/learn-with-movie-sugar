<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>English Quiz - Ms. Th√∫y</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #f8fafc;
  --card: #ffffff;
  --active: linear-gradient(90deg, #dbeafe, #eff6ff);
  --btn: #6366f1;
  --text: #1e293b;
}

body{ 
  margin:0; font-family:Poppins,sans-serif; background:var(--bg); color:var(--text);
  display: flex; flex-direction: column; min-height: 100vh;
}

header{ text-align:center; padding:15px; background: #fff; border-bottom: 1px solid #e2e8f0; }
header h1{ margin:0; font-size: 1.3rem; color: var(--btn); }

.main{
  display:grid; grid-template-columns: 1.2fr 1fr; gap:20px;
  padding: 20px; max-width: 1400px; margin: 0 auto; flex: 1;
}

@media(max-width:900px){ 
  .main{ grid-template-columns: 1fr; padding: 10px; }
  .video-container { position: sticky; top: 0; z-index: 100; background: var(--bg); padding-bottom: 10px; }
}

.card{ background:var(--card); border-radius:16px; padding:15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }

.subtitle-box { overflow-y: visible; }
@media(min-width:901px) { .subtitle-box { height: 75vh; overflow-y: auto; } }

.subtitle-line{ padding:18px; margin-bottom:12px; border-radius:12px; border: 1px solid #f1f5f9; background: #fff; }
.subtitle-line.active{ background: var(--active); border-color: #3b82f6; }

.row{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom: 5px; }
input{ padding:10px; border-radius:10px; border:1.5px solid #cbd5e1; width:150px; outline:none; font-size: 16px; }

button{ padding:10px 20px; border:none; border-radius:10px; cursor:pointer; background:var(--btn); color:white; font-weight:600; }

.result{ font-size: 14px; font-weight: 600; margin-left: 5px; }
.correct{ color:#10b981; }
.wrong{ color:#ef4444; }

.summary-footer { margin-top: auto; padding: 20px; background: #fff; border-top: 1px solid #e2e8f0; text-align: center; }

.switch-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 0.85rem; font-weight: 600; }
.switch { position: relative; display: inline-block; width: 36px; height: 18px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--btn); }
input:checked + .slider:before { transform: translateX(18px); }
</style>
</head>

<body>

<header><h1>Learn English with Ms. Th√∫y</h1></header>

<div class="main">
  <div class="video-container">
    <div class="card">
      <div class="switch-container">
        <span>T·ª± ƒë·ªông d·ª´ng video</span>
        <label class="switch"><input type="checkbox" id="autoPauseToggle" checked><span class="slider"></span></label>
      </div>
      <div style="position:relative; padding-bottom:56.25%; height:0; border-radius:12px; overflow:hidden; background:#000;">
        <iframe id="player" style="position:absolute; top:0; left:0; width:100%; height:100%;"
          src="https://www.youtube.com/embed/FjU9qyTZ_OU?enablejsapi=1" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
  </div>
  <div class="subtitle-box" id="subs"><p style="text-align:center;">ƒêang t·∫£i b√†i t·∫≠p...</p></div>
</div>

<div class="summary-footer">
  <button onclick="showSummary()" style="width: 100%; max-width: 400px;">üìä Xem t·ªïng k·∫øt k·∫øt qu·∫£</button>
  <p id="summaryResult" style="margin-top:10px; font-weight:bold;"></p>
</div>

<script>
let player;
let subtitles = [], results = [];
let currentLineIndex = -1;
let pausedIndices = new Set();
const stopWords=["the","a","an","to","of","and","or","is","was","were","be","have","has","had","in","on","at","for","with","that","this","it","as","by","from","but","so","if","then","than","you","are","aren't","your","my","their","his","her"];

function onYouTubeIframeAPIReady(){ player = new YT.Player('player'); }
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

function timeToSec(t){
    const parts = t.replace(",",".").split(":");
    return parseFloat(parts[0])*3600 + parseFloat(parts[1])*60 + parseFloat(parts[2]);
}

// H√ÄM CH·ªåN T·ª™ KH√ìA C·∫¢I TI·∫æN - S·ª¨A L·ªñI KH√îNG ƒê·ª§C L·ªñ
function chooseKeyword(sentence){
    // Lo·∫°i b·ªè d·∫•u c√¢u v√† t√°ch t·ª´
    let cleanWords = sentence.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g,"").split(/\s+/);
    
    // T√¨m c√°c t·ª´ kh√¥ng n·∫±m trong danh s√°ch c·∫•m v√† d√†i > 3 k√Ω t·ª±
    let candidates = cleanWords.filter(w => w.length > 3 && !stopWords.includes(w.toLowerCase()));
    
    // N·∫øu kh√¥ng c√≥ t·ª´ > 3 k√Ω t·ª±, l·∫•y c√°c t·ª´ kh√¥ng n·∫±m trong danh s√°ch c·∫•m (b·∫•t k·ªÉ ƒë·ªô d√†i)
    if(candidates.length === 0) {
        candidates = cleanWords.filter(w => !stopWords.includes(w.toLowerCase()));
    }
    
    // N·∫øu v·∫´n kh√¥ng c√≥ (to√†n t·ª´ c·∫•m), l·∫•y ƒë·∫°i m·ªôt t·ª´ b·∫•t k·ª≥ ·ªü gi·ªØa c√¢u ƒë·ªÉ ƒë·∫£m b·∫£o lu√¥n c√≥ l·ªó ƒë·ª•c
    if(candidates.length === 0) {
        return cleanWords[Math.floor(cleanWords.length / 2)];
    }

    // Ch·ªçn t·ª´ d√†i nh·∫•t trong danh s√°ch ·ª©ng vi√™n ƒë·ªÉ ƒë·ªë cho hay
    return candidates.reduce((a, b) => a.length >= b.length ? a : b);
}

fetch("subtitles.srt")
    .then(r => r.text())
    .then(data => {
        const blocks = data.trim().split(/\n\r?\n/);
        const box = document.getElementById("subs");
        box.innerHTML = ""; 
        blocks.forEach((block, i) => {
            const lines = block.split(/\r?\n/);
            if(lines.length >= 3){
                const timePart = lines[1].split(" --> ");
                const text = lines.slice(2).join(" ");
                const key = chooseKeyword(text);
                
                // T·∫°o c√¢u ƒë·ªë v·ªõi d·∫•u g·∫°ch d∆∞·ªõi b√°m s√°t ƒë·ªô d√†i t·ª´
                const underscore = "_".repeat(key.length + 2);

                subtitles.push({
                    start: timeToSec(timePart[0]),
                    end: timeToSec(timePart[1]),
                    full: text,
                    blank: text.replace(new RegExp(`\\b${key}\\b`,"i"), underscore), // D√πng \\b ƒë·ªÉ thay ƒë√∫ng t·ª´, tr√°nh thay nh·∫ßm t·ª´ con
                    answer: key
                });
                results.push(null);
                renderLine(i);
            }
        });
    });

function renderLine(i){
    const s = subtitles[i];
    const div = document.createElement("div");
    div.className = "subtitle-line";
    div.id = "line" + i;
    div.onclick = () => {
        pausedIndices.delete(i);
        player.seekTo(s.start, true);
        player.playVideo();
    };
    div.innerHTML = `
        <div class="row"><b style="font-size: 1.1rem; color: #334155; line-height:1.5;">${s.blank}</b></div>
        <div class="row" style="margin-top:12px;" onclick="event.stopPropagation()">
            <input id="in${i}" placeholder="Type word..." onkeypress="if(event.key==='Enter') check(${i})">
            <button onclick="check(${i})">Check</button>
            <span id="res${i}" class="result"></span>
        </div>
    `;
    document.getElementById("subs").appendChild(div);
}

function check(i){
    const val = document.getElementById("in"+i).value.trim().toLowerCase();
    const answer = subtitles[i].answer.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g,"");
    const res = document.getElementById("res"+i);
    
    if(val === answer){
        res.textContent = "‚úî Correct";
        res.className = "result correct";
        results[i] = true;
        player.playVideo();
    } else {
        res.textContent = "‚úò Try again";
        res.className = "result wrong";
        results[i] = false;
    }
}

setInterval(() => {
    if(!player || !player.getCurrentTime || player.getPlayerState() !== 1) return;
    const currentTime = player.getCurrentTime();
    let activeIndex = -1;
    for(let i=0; i < subtitles.length; i++){
        if(currentTime >= subtitles[i].start && currentTime < subtitles[i].end){
            activeIndex = i;
            break;
        }
    }
    if(activeIndex !== -1 && activeIndex !== currentLineIndex){
        if(currentLineIndex !== -1) document.getElementById("line"+currentLineIndex).classList.remove("active");
        const currentEl = document.getElementById("line"+activeIndex);
        currentEl.classList.add("active");
        currentEl.scrollIntoView({ behavior: "smooth", block: "center" });

        if(document.getElementById("autoPauseToggle").checked && !pausedIndices.has(activeIndex)){
            player.pauseVideo();
            pausedIndices.add(activeIndex);
            document.getElementById("in"+activeIndex).focus();
        }
        currentLineIndex = activeIndex;
    }
}, 300);

function showSummary(){
    const correct = results.filter(r => r === true).length;
    document.getElementById("summaryResult").textContent = `K·∫øt qu·∫£: ${correct} / ${subtitles.length} c√¢u ch√≠nh x√°c.`;
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}
</script>

</body>
</html>
