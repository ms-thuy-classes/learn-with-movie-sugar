<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Learn English with Ms. Th√∫y - Smart Pause</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #f8fafc;
  --card: #ffffff;
  --active: linear-gradient(90deg, #dbeafe, #eff6ff);
  --btn: #6366f1;
  --text: #1e293b;
}

body{ margin:0; font-family:Poppins,sans-serif; background:var(--bg); color:var(--text); }
header{ text-align:center; padding:20px; background: #fff; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; }
header h1{ margin:0; font-size: 1.5rem; color: var(--btn); }

.main{
  display:grid;
  grid-template-columns: 1.2fr 1fr;
  gap:20px;
  padding: 0 20px;
  max-width: 1400px;
  margin: auto;
}

@media(max-width:900px){ .main{grid-template-columns:1fr} }

.video-container { position: sticky; top: 20px; }

.card{
  background:var(--card);
  border-radius:16px;
  padding:15px;
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

.subtitle-box{
  height: 75vh;
  overflow-y: auto;
  padding-right: 10px;
}

.subtitle-line{
  padding:15px;
  margin-bottom:12px;
  border-radius:12px;
  border: 1px solid #f1f5f9;
  transition: all 0.2s ease;
  cursor:pointer;
}

.subtitle-line.active{ 
  background: var(--active); 
  border-color: #3b82f6;
  transform: scale(1.01);
}

.row{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom: 5px; }
input{ padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; width:140px; outline:none; }

button{
  padding:8px 16px; border:none; border-radius:8px; cursor:pointer;
  background:var(--btn); color:white; font-weight:500;
}

.trans-text { font-size: 0.85rem; color: #64748b; margin-top: 5px; display: block; }
.result{ font-size: 13px; font-weight: 600; }
.correct{ color:#10b981; }
.wrong{ color:#ef4444; }

/* Toggle Switch */
.switch-container {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  margin-bottom: 15px; font-size: 0.9rem; font-weight: 600;
}
.switch {
  position: relative; display: inline-block; width: 44px; height: 22px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc; transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
  background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--btn); }
input:checked + .slider:before { transform: translateX(22px); }

.subtitle-box::-webkit-scrollbar { width: 6px; }
.subtitle-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
</head>

<body>

<header>
  <h1>Learn English with Ms. Th√∫y</h1>
  <p>Video: <b>Addicted to Sugar</b></p>
</header>

<div class="main">
  <div class="video-container">
    <div class="card">
      <div class="switch-container">
        <span>T·ª± ƒë·ªông d·ª´ng khi c√≥ c√¢u ƒë·ªë</span>
        <label class="switch">
          <input type="checkbox" id="autoPauseToggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      
      <div style="position:relative; padding-bottom:56.25%; height:0; border-radius:12px; overflow:hidden; background:#000;">
        <iframe id="player" style="position:absolute; top:0; left:0; width:100%; height:100%;"
          src="https://www.youtube.com/embed/FjU9qyTZ_OU?enablejsapi=1" 
          frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
    
    <div class="card" style="margin-top: 20px; text-align: center;">
      <button onclick="showSummary()" style="width:100%">üìä T·ªïng k·∫øt k·∫øt qu·∫£</button>
      <p id="summaryResult" style="margin-top:10px; font-weight:bold;"></p>
    </div>
  </div>

  <div class="card subtitle-box" id="subs">
      <p style="text-align:center; padding-top:20px;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ GitHub...</p>
  </div>
</div>

<script>
let player;
let subtitles = [], results = [];
let currentLineIndex = -1;
let pausedIndices = new Set(); // ƒê·ªÉ tr√°nh d·ª´ng li√™n t·ª•c t·∫°i m·ªôt d√≤ng

const stopWords=["the","a","an","to","of","and","or","is","was","were","be","have","has","had","in","on","at","for","with","that","this","it","as","by","from","but","so","if","then","than"];

function onYouTubeIframeAPIReady(){ player = new YT.Player('player'); }
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

async function translateText(text) {
    try {
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi`);
        const data = await response.json();
        return data.responseData.translatedText;
    } catch (e) { return "..."; }
}

function timeToSec(t){
    const parts = t.replace(",",".").split(":");
    return parseFloat(parts[0])*3600 + parseFloat(parts[1])*60 + parseFloat(parts[2]);
}

function chooseKeyword(sentence){
    const words = sentence.toLowerCase().replace(/[^a-z\s]/g,"").split(" ").filter(w => w.length > 3 && !stopWords.includes(w));
    return words.length > 0 ? words[Math.floor(words.length/2)] : "sugar";
}

fetch("subtitles.srt")
    .then(r => r.text())
    .then(data => parseSRT(data))
    .catch(() => { document.getElementById("subs").innerHTML = "L·ªói t·∫£i file .srt"; });

async function parseSRT(data){
    const blocks = data.trim().split(/\n\r?\n/);
    const box = document.getElementById("subs");
    box.innerHTML = ""; 

    for(let i=0; i < blocks.length; i++){
        const lines = blocks[i].split(/\r?\n/);
        if(lines.length >= 3){
            const timePart = lines[1].split(" --> ");
            const text = lines.slice(2).join(" ");
            const key = chooseKeyword(text);

            subtitles.push({
                start: timeToSec(timePart[0]),
                end: timeToSec(timePart[1]),
                full: text,
                blank: text.replace(new RegExp(key,"i"), "______"),
                answer: key,
                vi: "ƒêang d·ªãch..."
            });
            results.push(null);
            renderLine(i);

            translateText(text).then(res => {
                subtitles[i].vi = res;
                const el = document.getElementById(`trans${i}`);
                if(el) el.textContent = "üáªüá≥ " + res;
            });
        }
    }
}

function renderLine(i){
    const s = subtitles[i];
    const div = document.createElement("div");
    div.className = "subtitle-line";
    div.id = "line" + i;
    div.onclick = () => {
        pausedIndices.delete(i); // Reset ƒë·ªÉ c√≥ th·ªÉ d·ª´ng l·∫°i n·∫øu click th·ªß c√¥ng
        player.seekTo(s.start, true);
        player.playVideo();
    };
    div.innerHTML = `
        <div class="row"><b style="font-size: 1.05rem;">${s.blank}</b></div>
        <span class="trans-text" id="trans${i}">üáªüá≥ ƒêang d·ªãch...</span>
        <div class="row" style="margin-top:12px;" onclick="event.stopPropagation()">
            <input id="in${i}" placeholder="ƒêi·ªÅn t·ª´..." onkeypress="if(event.key==='Enter') check(${i})">
            <button onclick="check(${i})">Check</button>
            <span id="res${i}" class="result"></span>
        </div>
    `;
    document.getElementById("subs").appendChild(div);
}

function check(i){
    const input = document.getElementById("in"+i);
    const val = input.value.trim().toLowerCase();
    const res = document.getElementById("res"+i);
    
    if(val === subtitles[i].answer.toLowerCase()){
        res.textContent = "‚úî Correct";
        res.className = "result correct";
        results[i] = true;
        player.playVideo(); // T·ª± ƒë·ªông ph√°t ti·∫øp khi ƒë√∫ng
    } else {
        res.textContent = "‚úò Wrong";
        res.className = "result wrong";
        results[i] = false;
    }
}

// Logic ƒë·ªìng b·ªô v√† Auto-Pause
setInterval(() => {
    if(!player || !player.getCurrentTime || player.getPlayerState() !== 1) return;
    
    const currentTime = player.getCurrentTime();
    let activeIndex = -1;

    for(let i=0; i < subtitles.length; i++){
        if(currentTime >= subtitles[i].start && currentTime < subtitles[i].end){
            activeIndex = i;
            break;
        }
    }

    if(activeIndex !== -1 && activeIndex !== currentLineIndex){
        // X·ª≠ l√Ω Active UI
        if(currentLineIndex !== -1) document.getElementById("line"+currentLineIndex).classList.remove("active");
        const currentEl = document.getElementById("line"+activeIndex);
        currentEl.classList.add("active");
        currentEl.scrollIntoView({ behavior: "smooth", block: "center" });

        // Logic Auto-Pause
        const isAutoPauseOn = document.getElementById("autoPauseToggle").checked;
        if(isAutoPauseOn && !pausedIndices.has(activeIndex)){
            player.pauseVideo();
            pausedIndices.add(activeIndex);
            document.getElementById("in"+activeIndex).focus(); // T·ª± ƒë·ªông ƒë∆∞a con tr·ªè v√†o √¥ nh·∫≠p
        }

        currentLineIndex = activeIndex;
    }
}, 200);

function showSummary(){
    const correct = results.filter(r => r === true).length;
    document.getElementById("summaryResult").textContent = `K·∫øt qu·∫£: ${correct} / ${subtitles.length} c√¢u.`;
}
</script>

</body>
</html>
