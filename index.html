<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Learn English with Ms. Th√∫y - Auto Translate</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg: linear-gradient(135deg,#fdfbfb,#e6f0ff);
  --card: #ffffff;
  --active: linear-gradient(90deg,#c7d2fe,#e0f2fe);
  --btn: linear-gradient(135deg,#93c5fd,#a5b4fc);
  --accent: #6366f1;
}

body{ margin:0; font-family:Poppins,sans-serif; background:var(--bg); color: #333; }
header{ text-align:center; padding:30px 20px; }
header h1{ margin:0; color: var(--accent); }
header p{ margin:8px 0; color:#666; }

.main{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:25px;
  padding:0 20px 20px;
  align-items:start;
}

@media(max-width:900px){ .main{grid-template-columns:1fr} }

.card{
  background:var(--card);
  border-radius:22px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.05);
}

.subtitle-box{
  max-height:75vh;
  overflow-y:auto;
  scroll-behavior: smooth;
}

.subtitle-line{
  padding:15px;
  margin-bottom:12px;
  border-radius:15px;
  border: 1px solid #f0f0f0;
  transition:.3s;
  cursor:pointer;
}

.subtitle-line.active{ background:var(--active); border-color: #93c5fd; }

.row{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom: 8px; }

input{
  padding:10px;
  border-radius:10px;
  border:1.5px solid #eee;
  width:150px;
}

button{
  padding:10px 16px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:var(--btn);
  color:white;
  font-weight:600;
}

.trans-text { font-size: 0.85em; color: #777; font-style: italic; display: block; }
.result{ font-size:14px; font-weight: 600; }
.correct{ color:#16a34a; }
.wrong{ color:#dc2626; }

.summary{ margin:20px auto; max-width: 400px; text-align:center; }
</style>
</head>

<body>

<header>
  <h1>Learn English with Ms. Th√∫y</h1>
  <p>Video: <b>Addicted to Sugar</b></p>
</header>

<div class="main">
  <div class="card" style="position: sticky; top: 20px;">
    <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius: 15px;">
        <iframe id="player" style="position:absolute; top:0; left:0; width:100%; height:100%;"
        src="https://www.youtube.com/embed/FjU9qyTZ_OU?enablejsapi=1" 
        frameborder="0" allowfullscreen></iframe>
    </div>
  </div>

  <div class="card subtitle-box" id="subs">
      <p style="text-align:center;">ƒêang ƒë·ªçc file ph·ª• ƒë·ªÅ...</p>
  </div>
</div>

<div class="summary card">
  <button onclick="showSummary()" style="width: 100%;">üìä T·ªïng k·∫øt k·∫øt qu·∫£</button>
  <p id="summaryResult"></p>
</div>

<script>
const stopWords=["the","a","an","to","of","and","or","is","was","were","be","have","has","had","in","on","at","for","with","that","this","it","as","by","from","but","so","if","then","than"];

let player;
let subtitles = [], results = [];

function onYouTubeIframeAPIReady(){ player = new YT.Player('player'); }
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

// API D·ªãch thu·∫≠t MyMemory
async function translateText(text) {
    try {
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi`);
        const data = await response.json();
        return data.responseData.translatedText || "D·ªãch t·ª± ƒë·ªông l·ªói";
    } catch (e) {
        return "...";
    }
}

function chooseKeyword(sentence){
    const words = sentence.toLowerCase().replace(/[^a-z\s]/g,"").split(" ").filter(w => w.length > 3 && !stopWords.includes(w));
    return words.length > 0 ? words[Math.floor(words.length/2)] : "sugar";
}

function timeToSec(t){
    const [h,m,s] = t.replace(",",".").split(":");
    return +h*3600 + +m*60 + +s;
}

// === LOAD FILE TH·∫¨T ===
fetch("subtitles.srt")
    .then(r => r.text())
    .then(data => parseSRT(data))
    .catch(err => {
        document.getElementById("subs").innerHTML = "L·ªói: Kh√¥ng t√¨m th·∫•y file 'subtitles.srt' trong c√πng th∆∞ m·ª•c.";
    });

async function parseSRT(data){
    const blocks = data.trim().split(/\n\n+/);
    const box = document.getElementById("subs");
    box.innerHTML = ""; 

    for(let i=0; i < blocks.length; i++){
        const lines = blocks[i].split("\n");
        if(lines.length >= 3){
            const time = lines[1].split(" --> ");
            const text = lines.slice(2).join(" ");
            const key = chooseKeyword(text);

            const s = {
                start: timeToSec(time[0]),
                end: timeToSec(time[1]),
                full: text,
                blank: text.replace(new RegExp(key,"i"), "______"),
                answer: key,
                vi: "ƒêang d·ªãch..." // T·∫°m th·ªùi hi·ªán c√°i n√†y
            };
            
            subtitles.push(s);
            results.push(null);
            
            // V·∫Ω giao di·ªán ngay l·∫≠p t·ª©c
            renderLine(i);

            // G·ªçi d·ªãch ng·∫ßm sau ƒë√≥ c·∫≠p nh·∫≠t l·∫°i
            translateText(text).then(translated => {
                subtitles[i].vi = translated;
                document.getElementById(`trans${i}`).textContent = "üáªüá≥ " + translated;
            });
        }
    }
}

function renderLine(i){
    const s = subtitles[i];
    const div = document.createElement("div");
    div.className = "subtitle-line";
    div.id = "line" + i;
    div.innerHTML = `
        <div class="row" onclick="player.seekTo(${s.start}, true)">
            <b style="font-size: 1.05em;">${s.blank}</b>
        </div>
        <div class="row">
            <span class="trans-text" id="trans${i}">üáªüá≥ ${s.vi}</span>
        </div>
        <div class="row">
            <input id="in${i}" placeholder="Type word" onkeypress="if(event.key==='Enter') check(${i})">
            <button onclick="check(${i})">Check</button>
            <span id="res${i}" class="result"></span>
        </div>
    `;
    document.getElementById("subs").appendChild(div);
}

function check(i){
    const val = document.getElementById("in"+i).value.trim().toLowerCase();
    const res = document.getElementById("res"+i);
    if(val === subtitles[i].answer.toLowerCase()){
        res.textContent = "‚úî Correct";
        res.className = "result correct";
        results[i] = true;
    } else {
        res.textContent = "‚úò Wrong";
        res.className = "result wrong";
        results[i] = false;
    }
}

setInterval(() => {
    if(!player || !player.getCurrentTime) return;
    const t = player.getCurrentTime();
    subtitles.forEach((s, i) => {
        const line = document.getElementById("line" + i);
        if(line) {
            if(t >= s.start && t < s.end){
                line.classList.add("active");
                // T·ª± ƒë·ªông cu·ªôn m∆∞·ª£t m√†
                if(line.getAttribute('data-scrolled') !== 'true'){
                    line.scrollIntoView({behavior: "smooth", block: "center"});
                    line.setAttribute('data-scrolled', 'true');
                }
            } else {
                line.classList.remove("active");
                line.removeAttribute('data-scrolled');
            }
        }
    });
}, 400);

function showSummary(){
    const correct = results.filter(r => r === true).length;
    document.getElementById("summaryResult").textContent = `B·∫°n ƒë√£ ho√†n th√†nh ${correct} / ${subtitles.length} c√¢u.`;
}
</script>

</body>
</html>
